<%- include('partials/header') %>
<%- include('partials/_flash') %>




<div class="min-h-screen flex gap-10 px-6 py-12 bg-gray-50">
  <!-- Sidebar -->
  <aside class="w-1/4 space-y-10">

    <div class="space-y-4">
      <h3 class="text-lg font-semibold text-gray-700">Filter by</h3>
      <label class="block text-sm mb-2">Max Distance (km):</label>
      <input type="number" id="distanceFilter" min="0" step="0.1" class="border rounded px-2 py-1 w-full mb-2" placeholder="e.g. 5">
      <label class="block text-sm mb-2">Min Review (stars):</label>
      <select id="reviewFilter" class="border rounded px-2 py-1 w-full">
        <option value="0">Any</option>
        <option value="3">3+</option>
        <option value="4">4+</option>
        <option value="5">5</option>
      </select>
      <button onclick="applyFilters()" class="bg-indigo-600 text-white px-4 py-2 rounded mt-2 w-full">Apply</button>
    </div>
  </aside>

  <!-- Main Content -->
  <div class="flex-1">
    <!-- Recommendation Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-8 recommendations-grid">
      <!-- Recommendations will be rendered by JS for filtering -->
    </div>

    <!-- Map -->
    <div class="mt-10">
      <h2 class="text-2xl font-bold mb-4 text-gray-800">Map View</h2>
      <div id="map" style="height:500px; width:100%;" class="rounded-lg shadow-md"></div>
    </div>
  </div>
</div>


<script>
  const recommendationsData = <%- JSON.stringify(recommendations) %>;

  function renderRecommendations(filtered) {
    const grid = document.querySelector('.recommendations-grid');
    grid.innerHTML = '';
    if (filtered.length === 0) {
      grid.innerHTML = '<p class="text-gray-600 text-lg col-span-3">No recommendations found.</p>';
      return;
    }
    filtered.forEach(r => {
      const sentiment = r.sentimentScore || 0;
      const stars = Math.round(sentiment * 5);
      grid.innerHTML += `
        <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-shadow duration-300">
          <div class="relative">
            <img src="${r.restaurant.picture}" alt="${r.restaurant.name} image" class="w-full h-48 object-cover" onerror="this.onerror=null; this.src='/images/default.jpg';"/>
            <div class="absolute inset-0 bg-black opacity-20"></div>
          </div>
          <div class="p-6 space-y-2">
            <h4 class="font-semibold text-lg text-gray-800">${r.restaurant.name}</h4>
            <span class="block text-gray-500 text-sm">${r.restaurant.address}</span>
            ${typeof r.distanceKm !== 'undefined' && r.distanceKm > 0 ? `<span class="block text-gray-700 text-sm">üìç ${r.distanceKm.toFixed(2)} km away</span>` : ''}
            <div class="flex items-center space-x-1">
              ${Array.from({length: 5}, (_, i) => i < stars ? '<span class="text-yellow-400 text-lg">‚òÖ</span>' : '<span class="text-gray-300 text-lg">‚òÖ</span>').join('')}
            </div>
            <a href="/restaurant/details/${r.restaurant._id}?search=${encodeURIComponent(window.query || '')}" class="inline-block bg-indigo-600 text-white px-4 py-2 mt-3 rounded hover:bg-indigo-700">Order</a>
          </div>
        </div>
      `;
    });
  }

  function applyFilters() {
    const maxDist = parseFloat(document.getElementById('distanceFilter').value) || Infinity;
    const minStars = parseInt(document.getElementById('reviewFilter').value) || 0;
    const filtered = recommendationsData.filter(r => {
      const distOk = typeof r.distanceKm === 'undefined' || r.distanceKm <= maxDist;
      const stars = Math.round((r.sentimentScore || 0) * 5);
      const reviewOk = stars >= minStars;
      return distOk && reviewOk;
    });
    renderRecommendations(filtered);
  }

  // Get search query from URL
  window.query = new URLSearchParams(window.location.search).get('query') || '';
  // Initial render
  document.addEventListener('DOMContentLoaded', () => {
    renderRecommendations(recommendationsData);
  });
</script>
<script src="/js/map.js"></script>
<!-- Add Google Maps -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key=<%= process.env.GOOGLE_MAPS_API_KEY %>&callback=initMap">
</script>

<%- include('partials/footer') %>
