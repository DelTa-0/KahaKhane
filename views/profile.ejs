<%- include('partials/header', { title: 'Profile - Foodie' }) %>
<%- include('partials/_flash') %>

<body class="bg-gray-100 font-sans">
  <div class="max-w-5xl mx-auto py-12 px-4">
    <h1 class="text-3xl font-bold text-center mb-8 text-blue-600">
      Welcome, <%= user.fullname %>!
    </h1>

    <% if (orders.length === 0) { %>
      <p class="text-xl text-gray-600 text-center">
        You have no completed orders yet.
      </p>
    <% } else { %>
      <h2 class="text-2xl font-semibold text-gray-800 mb-6">Your Recent Orders</h2>

      <% 
        // sort by date (most recent first)
        const sortedOrders = orders.slice().sort((a,b) => new Date(b.orderedAt) - new Date(a.orderedAt));
        for (let orderIndex = 0; orderIndex < sortedOrders.length; orderIndex++) {
          const order = sortedOrders[orderIndex];
      %>
        <div class="bg-white shadow-lg rounded-xl mb-6 p-6">
          <!-- Overall order info -->
          <div class="flex items-center justify-between">
            <div>
              <p class="text-lg font-medium text-gray-700">
                Ordered on: <span class="font-semibold"><%= new Date(order.orderedAt).toLocaleString() %></span>
              </p>
              <p class="text-sm text-gray-500">Total Price: ₹<%= order.totalPrice %></p>
              <p class="text-sm text-gray-500">Payment: <%= order.paymentMethod %></p>
            </div>
            <button
              onclick="toggleOrderDetails(<%= orderIndex %>)"
              class="ml-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-500 focus:outline-none"
            >
              View Order Details
            </button>
          </div>

          <!-- Items inside this order -->
          <div id="orderDetails<%= orderIndex %>" class="hidden mt-6 border-t border-gray-200 pt-4">
            <ul class="space-y-6">
            <% order.items.forEach(item => {
              const key = order._id + '_' + item.food.name;
              const alreadyReviewed = reviewedKeys.includes(key);
            %>
              <li class="border-b border-gray-300 pb-4">
                <div>
                  <h3 class="text-lg font-semibold text-gray-800"><%= item.food.name %></h3>
                  <p class="text-sm text-gray-600">From: <%= item.restaurant ? item.restaurant.name : 'Unknown Restaurant' %></p>
                </div>

                <!-- Review Section -->
                <% if (!alreadyReviewed) { %>
                  <div class="mt-4">
                    <label class="flex items-center space-x-2">
                      <input 
                        type="checkbox" 
                        id="reviewCheckbox<%= item._id %>" 
                        onclick="toggleReviewForm('<%= item._id %>')" 
                        class="text-blue-600"
                      >
                      <span class="text-sm text-gray-700">Would you like to review this item?</span>
                    </label>
                  </div>

                  <!-- Review Form - Initially hidden -->
                  <form id="reviewForm<%= item._id %>" action="/review" method="POST" class="mt-4 hidden space-y-4">
                    <input type="hidden" name="restaurant_id" value="<%= item.restaurant ? item.restaurant._id : '' %>">
                    <input type="hidden" name="food_name" value="<%= item.food.name %>">
                    <input type="hidden" name="order_id" value="<%= order._id %>">
                    <textarea name="review" placeholder="Write your review..." required class="w-full p-2 border rounded-lg"></textarea>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-500 w-full">Submit Review</button>
                  </form>
                <% } else { %>
                  <p class="text-green-500 mt-2">✅ You have already reviewed this item for this order.</p>
                <% } %>
              </li>
            <% }) %>
            </ul>
          </div>
        </div>
      <% } %>
    <% } %>
  </div>

  <!-- Toggle order details visibility -->
  <script>
    function toggleOrderDetails(orderIndex) {
      const el = document.getElementById('orderDetails' + orderIndex);
      el.classList.toggle('hidden');
    }

    // Show or hide the review form based on checkbox
    function toggleReviewForm(itemId) {
      const checkbox = document.getElementById('reviewCheckbox' + itemId);
      const form = document.getElementById('reviewForm' + itemId);
      if (checkbox.checked) {
        form.classList.remove('hidden');
      } else {
        form.classList.add('hidden');
      }
    }
  </script>
</body>

<%- include('partials/footer') %>
